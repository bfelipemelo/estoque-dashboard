<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestão Centralizada de Estoque</title>
    <!-- Carrega o Tailwind CSS via CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
    </style>
</head>
<body class="bg-gray-50 p-4 sm:p-8">
    <div id="app" class="max-w-7xl mx-auto">
        <!-- Conteúdo será injetado pelo JavaScript -->
    </div>

    <script type="text/javascript">
        // Chaves para salvar os dados no LocalStorage
        const STORAGE_KEY = 'inventoryData'; 
        const ORDERS_KEY = 'pendingOrdersData';

        // --- DADOS DE ESTOQUE (Com Curva ABC/XYZ Adicionada para Transferências) ---
        const defaultStockData = [
            { id: 1, revenda: 1, sku: 'GS55553R2BRA', desc: 'ÓLEO 5W40 MOTOR MAXI PERFORMANCE', category: 'LUB', qtd_cont: 1800, qtd_disp: 1770, qtd_conf: 10, qtd_aloc: 5, qtd_orcad: 5, qtd_negoc: 10, demanda: 8173.67, curve: 'A-1' }, 
            { id: 2, revenda: 1, sku: '6EA061500', desc: 'TAPETE BORRACHA POLO / NIVUS', category: 'ACE', qtd_cont: 10, qtd_disp: 8, qtd_conf: 0, qtd_aloc: 0, qtd_orcad: 2, qtd_negoc: 0, demanda: 20.50, curve: 'A-2' }, 
            { id: 3, revenda: 1, sku: 'N10746301', desc: 'PARAFUSO DE APOIO', category: 'PCM', qtd_cont: 20, qtd_disp: 20, qtd_conf: 0, qtd_aloc: 0, qtd_orcad: 0, qtd_negoc: 0, demanda: 0.00, curve: 'C-3' },
            { id: 4, revenda: 1, sku: 'V04010023AJ', desc: 'CÂMERA DE RÉ POLO - QUANTUM', category: 'ACE', qtd_cont: 4, qtd_disp: 3, qtd_conf: 1, qtd_aloc: 0, qtd_orcad: 0, qtd_negoc: 0, demanda: 9.83, curve: 'A-1' }, 
            { id: 5, revenda: 1, sku: 'WHT004899', desc: 'PARAFUSO RODA FERRO', category: 'PCM', qtd_cont: 25, qtd_disp: 21, qtd_conf: 4, qtd_aloc: 0, qtd_orcad: 0, qtd_negoc: 0, demanda: 0.50, curve: 'B-2' },
            { id: 6, revenda: 1, sku: '82273188', desc: 'PARAFUSO DA RODA DIANTEIRA', category: 'PCM', qtd_cont: 150, qtd_disp: 150, qtd_conf: 0, qtd_aloc: 0, qtd_orcad: 0, qtd_negoc: 0, demanda: 0.15, curve: 'B-3' }, 
            { id: 7, revenda: 1, sku: '1119530411', desc: 'LANTERNA TRASEIRA FUSCA', category: 'PCE', qtd_cont: 5, qtd_disp: 5, qtd_conf: 0, qtd_aloc: 0, qtd_orcad: 0, qtd_negoc: 0, demanda: 0.80, curve: 'C-1' },
            { id: 8, revenda: 2, sku: 'GS55553R2BRA', desc: 'ÓLEO 5W40 MOTOR MAXI PERFORMANCE', category: 'LUB', qtd_cont: 500, qtd_disp: 490, qtd_conf: 10, qtd_aloc: 0, qtd_orcad: 0, qtd_negoc: 0, demanda: 1142.33, curve: 'A-1' },
            { id: 9, revenda: 2, sku: 'GS55545M2BRA', desc: 'ÓLEO 0W30 MOTOR MAXI PERFORMANCE AMAROK', category: 'LUB', qtd_cont: 560, qtd_disp: 553, qtd_conf: 7, qtd_aloc: 0, qtd_orcad: 0, qtd_negoc: 0, demanda: 6.83, curve: 'B-1' },
            { id: 10, revenda: 2, sku: '5U0601155FZ31', desc: 'CALOTA 14 GOL VOYAGE 2017>', category: 'ACE', qtd_cont: 10, qtd_disp: 9, qtd_conf: 1, qtd_aloc: 0, qtd_orcad: 0, qtd_negoc: 0, demanda: 0.00, curve: 'C-3' },
            { id: 11, revenda: 2, sku: '377947561D', desc: 'INTERRUPTOR ALARME PORTA FOX/ GOL', category: 'ACE', qtd_cont: 150, qtd_disp: 141, qtd_conf: 9, qtd_aloc: 0, qtd_orcad: 0, qtd_negoc: 0, demanda: 0.50, curve: 'B-3' },
            { id: 12, revenda: 3, sku: 'WHT004899', desc: 'PARAFUSO RODA FERRO GOL/VOYAGE', category: 'PCM', qtd_cont: 30, qtd_disp: 21, qtd_conf: 9, qtd_aloc: 0, qtd_orcad: 0, qtd_negoc: 0, demanda: 0.50, curve: 'B-2' },
            { id: 13, revenda: 3, sku: 'V04010057AE7Q', desc: 'FRISO LATERAL POLO - PRATA SIRIUS', category: 'ACE', qtd_cont: 60, qtd_disp: 56, qtd_conf: 4, qtd_aloc: 0, qtd_orcad: 0, qtd_negoc: 0, demanda: 0.17, curve: 'C-2' }, 
            { id: 14, revenda: 3, sku: '1119530411', desc: 'LANTERNA TRASEIRA FUSCA', category: 'PCE', qtd_cont: 5, qtd_disp: 5, qtd_conf: 0, qtd_aloc: 0, qtd_orcad: 0, qtd_negoc: 0, demanda: 0.80, curve: 'C-1' },
            { id: 15, revenda: 3, sku: '82273188', desc: 'PARAFUSO DA RODA DIANTEIRA', category: 'PCM', qtd_cont: 10, qtd_disp: 10, qtd_conf: 0, qtd_aloc: 0, qtd_orcad: 0, qtd_negoc: 0, demanda: 0.15, curve: 'B-3' }, 
        ];

        // --- DADOS DE PEDIDOS EM ANDAMENTO (Novo) ---
        const defaultPendingOrders = [
            { id: 101, sku: 'GS55553R2BRA', desc: 'ÓLEO 5W40 MOTOR MAXI PERFORMANCE', qtd_pedida: 5000, fornecedor: 'Shell Brasil', status: 'Em Trânsito', previsao: '25/10/2025' },
            { id: 102, sku: '6EA061500', desc: 'TAPETE BORRACHA POLO / NIVUS', qtd_pedida: 50, fornecedor: 'Acessórios SP', status: 'Processando', previsao: '05/11/2025' },
            { id: 103, sku: 'V04010023AJ', desc: 'CÂMERA DE RÉ POLO - QUANTUM', qtd_pedida: 20, fornecedor: 'Quantum Tech', status: 'Aguardando Faturamento', previsao: '28/10/2025' },
        ];


        const METRICS = [
            { key: 'qtd_cont', label: 'Contábil', color: 'text-indigo-600' },
            { key: 'qtd_disp', label: 'Disponível', color: 'text-green-600' },
            { key: 'qtd_conf', label: 'Conferência', color: 'text-yellow-600' },
            { key: 'qtd_orcad', label: 'Orçado', color: 'text-blue-600' },
            { key: 'qtd_aloc', label: 'Alocado', color: 'text-red-600' },
            { key: 'qtd_negoc', label: 'Negociação', color: 'text-purple-600' },
        ];

        // --- Variáveis de Estado (Simulação de React Hooks) ---
        let currentStockData = []; 
        let currentPendingOrders = [];
        let searchTerm = '';
        let selectedCategory = 'All';
        let showSuggestionsOnly = false;
        let activeTab = 'details'; 

        // --- Funções de Persistência (Local Storage) ---

        function loadStockData() {
            try {
                const storedData = localStorage.getItem(STORAGE_KEY);
                const storedOrders = localStorage.getItem(ORDERS_KEY);
                
                currentStockData = storedData ? JSON.parse(storedData) : defaultStockData;
                currentPendingOrders = storedOrders ? JSON.parse(storedOrders) : defaultPendingOrders;
                
            } catch (e) {
                console.error("Erro ao carregar dados do localStorage, usando dados padrões:", e);
                currentStockData = defaultStockData;
                currentPendingOrders = defaultPendingOrders;
            }
        }

        function saveStockData(stockData, ordersData) {
            try {
                localStorage.setItem(STORAGE_KEY, JSON.stringify(stockData));
                localStorage.setItem(ORDERS_KEY, JSON.stringify(ordersData));
            } catch (e) {
                console.error("Erro ao salvar dados no localStorage:", e);
            }
        }

        // --- Funções Auxiliares (Formatação) ---

        const formatNumber = (value) => value ? value.toLocaleString('pt-BR', { maximumFractionDigits: 0 }) : '0';
        const formatDecimal = (value) => value ? value.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) : '0.00';
        
        const calculateCoverage = (available, demand) => {
            if (demand <= 0.0) return Infinity; // Usar Infinity para cálculos de transferência
            return available / demand;
        };
        
        const formatCoverage = (coverageValue) => {
            if (coverageValue === Infinity) return '∞ (Estagnado)';
            return coverageValue < 1000 ? `${coverageValue.toFixed(2)} meses` : '> 1000 meses';
        };

        const generateMetricCard = (title, value, color) => `
            <div class="p-4 bg-white rounded-xl shadow-md border border-gray-100 transition hover:shadow-lg">
                <p class="text-sm font-medium text-gray-500">${title}</p>
                <p class="text-3xl font-extrabold mt-1 ${color}">${formatNumber(value)}</p>
            </div>
        `;

        // --- Funções de Renderização (Reorganizadas para correção de erro) ---

        function renderGlobalTotals(totals) {
            let html = '';
            METRICS.forEach(m => {
                html += generateMetricCard(m.label, totals[m.key] || 0, m.color);
            });
            html += generateMetricCard("Demanda Média Total", Math.round(totals.demanda || 0), "text-pink-600");

            document.getElementById('global-totals').innerHTML = `
                <h2 class="text-xl font-bold text-gray-800 mb-4">Estoque Total Consolidado</h2>
                <div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-7 gap-4 mb-8">
                    ${html}
                </div>
            `;
        }

        function renderRevendaTotals(revendaTotals) {
            const tbodyContent = revendaTotals.map(total => `
                <tr class="hover:bg-indigo-50">
                    <td class="px-4 py-3 whitespace-nowrap text-sm font-extrabold text-indigo-700">
                        Revenda ${total.revenda}
                    </td>
                    ${METRICS.map(m => `
                        <td class="px-4 py-3 whitespace-nowrap text-sm text-center font-semibold text-gray-800">
                            ${formatNumber(total[m.key] || 0)}
                        </td>
                    `).join('')}
                    <td class="px-4 py-3 whitespace-nowrap text-sm text-center font-semibold text-pink-700">
                        ${formatNumber(Math.round(total.demanda || 0))}
                    </td>
                </tr>
            `).join('');

            document.getElementById('revenda-totals-container').innerHTML = `
                <h2 class="text-xl font-bold text-gray-800 mb-4">Totais Agregados por Revenda</h2>
                <div class="overflow-x-auto bg-white rounded-xl shadow-lg">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-100">
                            <tr>
                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Revenda</th>
                                ${METRICS.map(m => `<th class="px-4 py-2 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">${m.label}</th>`).join('')}
                                <th class="px-4 py-2 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Demanda Média</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200">
                            ${tbodyContent}
                        </tbody>
                    </table>
                </div>
            `;
        }
        
        function renderPendingOrders(ordersData) {
            const tbodyContent = ordersData.map(order => {
                const statusColor = order.status === 'Em Trânsito' ? 'bg-blue-100 text-blue-700' : 
                                    order.status === 'Aguardando Faturamento' ? 'bg-yellow-100 text-yellow-700' : 'bg-gray-100 text-gray-700';

                return `
                    <tr class="hover:bg-gray-50">
                        <td class="px-4 py-3 whitespace-nowrap text-sm font-bold text-gray-900">${order.sku}</td>
                        <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-500">${order.desc}</td>
                        <td class="px-4 py-3 whitespace-nowrap text-sm font-semibold text-gray-800 text-center">${formatNumber(order.qtd_pedida)}</td>
                        <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-700">${order.fornecedor}</td>
                        <td class="px-4 py-3 whitespace-nowrap text-sm font-medium">
                            <span class="px-2 py-1 inline-flex text-xs leading-5 font-semibold rounded-full ${statusColor}">
                                ${order.status}
                            </span>
                        </td>
                        <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-700">${order.previsao}</td>
                    </tr>
                `;
            }).join('');

            return `
                <div class="p-6 rounded-xl shadow-lg mb-8 border-t-2 border-purple-500 bg-white">
                    <h3 class="text-xl font-bold text-purple-700 mb-3">
                        Pedidos de Compra Ativos (${ordersData.length})
                    </h3>
                    <p class="text-sm text-gray-600">
                        Acompanhamento dos itens já solicitados a fornecedores.
                    </p>
                </div>
                <div class="overflow-x-auto bg-white rounded-xl shadow-lg mt-4">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">SKU</th>
                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Descrição</th>
                                <th class="px-4 py-2 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Qtd. Pedida</th>
                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Fornecedor</th>
                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Previsão</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200">
                            ${tbodyContent}
                        </tbody>
                    </table>
                </div>
            `;
        }

        function renderTransferSuggestions(transfers) {
            const tbodyContent = transfers.map(t => `
                <tr class="bg-green-50 hover:bg-green-100">
                    <td class="px-4 py-3 whitespace-nowrap text-sm font-bold text-gray-900">
                        <div class="font-bold">${t.sku}</div>
                        <div class="text-gray-500 text-xs truncate max-w-xs">${t.desc}</div>
                    </td>
                    <td class="px-4 py-3 whitespace-nowrap text-sm font-semibold text-gray-700 text-center">${t.category}</td>
                    <td class="px-4 py-3 whitespace-nowrap text-sm font-semibold text-gray-700 text-center">${t.curve}</td>
                    <td class="px-4 py-3 whitespace-nowrap text-sm font-extrabold text-green-700 text-center">Revenda ${t.fromRevenda}</td>
                    <td class="px-4 py-3 whitespace-nowrap text-sm font-extrabold text-red-700 text-center">Revenda ${t.toRevenda}</td>
                    <td class="px-4 py-3 whitespace-nowrap text-sm font-extrabold text-red-600 text-center">${formatNumber(t.transferQty)}</td>
                    <td class="px-4 py-3 whitespace-nowrap text-sm text-green-700 text-center">${t.surplusCoverage}</td>
                    <td class="px-4 py-3 whitespace-nowrap text-sm text-red-700 text-center">${t.deficitCoverage}</td>
                </tr>
            `).join('');

            return `
                <div class="p-6 rounded-xl shadow-lg mb-8 border-t-2 border-green-500 bg-white">
                    <h3 class="text-xl font-bold text-green-700 mb-3">
                        Sugestões de Transferência Interna (${transfers.length})
                    </h3>
                    <p class="text-sm text-gray-600">
                        **Critério:** Mover estoque de revendas com excesso (> 3 meses) para revendas com risco de falta (< 1 mês) para itens de Curva Alta/Média (A/B).
                    </p>
                </div>
                <div class="overflow-x-auto bg-white rounded-xl shadow-lg mt-4">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">SKU / Descrição</th>
                                <th class="px-4 py-2 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Cat.</th>
                                <th class="px-4 py-2 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Curva</th>
                                <th class="px-4 py-2 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">De (Surplus)</th>
                                <th class="px-4 py-2 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Para (Deficit)</th>
                                <th class="px-4 py-2 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Qtd. a Transferir</th>
                                <th class="px-4 py-2 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Cobertura Surplus</th>
                                <th class="px-4 py-2 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Cobertura Deficit</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200">
                            ${tbodyContent}
                        </tbody>
                    </table>
                </div>
            `;
        }
        
        function renderItemTable(data, containerId, showSuggestions = false) {
            const tableData = showSuggestions ? data.filter(item => item.suggestion) : data;

            const tbodyContent = tableData.map(item => {
                const isSuggested = item.suggestion;
                
                return `
                    <tr class="${isSuggested ? 'bg-red-50 hover:bg-red-100' : 'hover:bg-gray-50'}">
                        <td class="px-4 py-3 whitespace-nowrap text-sm font-medium text-gray-900">
                            <div class="font-bold">${item.sku}</div>
                            <div class="text-gray-500 text-xs truncate max-w-xs">${item.desc}</div>
                        </td>
                        <td class="px-4 py-3 whitespace-nowrap text-sm text-center text-gray-500">${item.revenda}</td>
                        <td class="px-4 py-3 whitespace-nowrap text-xs text-center font-semibold text-gray-700">${item.category}</td>
                        ${METRICS.map(m => `
                            <td class="px-4 py-3 whitespace-nowrap text-sm text-center font-bold ${isSuggested && (m.key === 'qtd_disp') ? 'text-red-700' : 'text-gray-800'}">
                                ${formatNumber(item[m.key])}
                            </td>
                        `).join('')}
                        <td class="px-4 py-3 whitespace-nowrap text-sm text-center text-gray-700">${formatDecimal(item.demanda)}</td>
                        <td class="px-4 py-3 whitespace-nowrap text-sm text-center text-gray-700">
                            ${formatCoverage(calculateCoverage(item.qtd_disp, item.demanda))}
                        </td>
                        ${showSuggestions ? `
                            <td class="px-4 py-3 whitespace-nowrap text-sm text-center font-extrabold text-red-600">
                                ${formatNumber(item.suggestion)}
                            </td>
                        ` : ''}
                    </tr>
                `;
            }).join('');

            const tableHtml = `
                <div class="overflow-x-auto bg-white rounded-xl shadow-lg mt-4">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">SKU / Descrição</th>
                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Revenda</th>
                                <th class="px-4 py-2 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Cat.</th>
                                ${METRICS.map(m => `<th class="px-4 py-2 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">${m.label}</th>`).join('')}
                                <th class="px-4 py-2 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Demanda Média</th>
                                <th class="px-4 py-2 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Cobertura</th>
                                ${showSuggestions ? `<th class="px-4 py-2 text-center text-xs font-medium text-red-500 uppercase tracking-wider">Comprar Qtd.</th>` : ''}
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200">
                            ${tbodyContent}
                        </tbody>
                    </table>
                    ${tableData.length === 0 ? '<div class="text-center p-8 text-gray-500">Nenhum item encontrado.</div>' : ''}
                </div>
            `;

            document.getElementById(containerId).innerHTML = tableHtml;
        }


        // --- Lógica de Processamento ---

        function calculateTransfers(processedData) {
            const transferSuggestions = [];
            const itemsBySku = processedData.reduce((acc, item) => {
                acc[item.sku] = acc[item.sku] || [];
                // Adiciona a cobertura formatada para facilitar a ordenação e a exibição
                acc[item.sku].push({ 
                    ...item, 
                    coverageValue: calculateCoverage(item.qtd_disp, item.demanda) 
                });
                return acc;
            }, {});

            for (const sku in itemsBySku) {
                const locations = itemsBySku[sku];
                if (locations.length < 2) continue; // Precisa de pelo menos duas revendas para transferência

                // Ordenar por Cobertura: Menor cobertura = Risco (Deficit), Maior cobertura = Excesso (Surplus)
                locations.sort((a, b) => a.coverageValue - b.coverageValue);

                const deficitItem = locations[0];
                const surplusItem = locations[locations.length - 1];

                // Regras de Transferência:
                // 1. Deficit: Cobertura de risco (abaixo de 1.0 mês) E demanda > 0
                // 2. Surplus: Cobertura de excesso (acima de 3.0 meses) E tem estoque disponível
                
                const isDeficit = deficitItem.coverageValue < 1.0 && deficitItem.demanda > 0;
                const isSurplus = surplusItem.coverageValue > 3.0 && surplusItem.qtd_disp > 0;

                if (isDeficit && isSurplus) {
                    // Cálculo da Quantidade: Transferir o necessário para o deficit atingir 2 meses
                    const targetCoverage = 2.0; 
                    const neededQty = Math.ceil((deficitItem.demanda * targetCoverage) - deficitItem.qtd_disp);
                    
                    if (neededQty > 0) {
                        const transferQty = Math.min(neededQty, surplusItem.qtd_disp);
                        
                        // Não sugerir se a transferência não for significativa (ex: < 5 unidades)
                        if (transferQty >= 5) { 
                             transferSuggestions.push({
                                sku: sku,
                                desc: deficitItem.desc,
                                category: deficitItem.category,
                                curve: deficitItem.curve,
                                fromRevenda: surplusItem.revenda,
                                toRevenda: deficitItem.revenda,
                                transferQty: transferQty,
                                deficitCoverage: formatCoverage(deficitItem.coverageValue),
                                surplusCoverage: formatCoverage(surplusItem.coverageValue),
                            });
                        }
                    }
                }
            }

            // Priorizar transferências por Curva (A > B > C)
            transferSuggestions.sort((a, b) => {
                const curveOrder = { 'A-1': 1, 'A-2': 2, 'A-3': 3, 'B-1': 4, 'B-2': 5, 'B-3': 6, 'C-1': 7, 'C-2': 8, 'C-3': 9 };
                return curveOrder[a.curve] - curveOrder[b.curve];
            });

            return transferSuggestions;
        }

        function processData(data) {
            const processedData = data.map(item => {
                // Lógica de Sugestão de Compra (Externa)
                const safetyStockThreshold = item.demanda * 1.5; 
                const needsPurchase = item.demanda > 0 && item.qtd_disp < safetyStockThreshold;
                
                let suggestion = 0;
                if (needsPurchase) {
                    const targetCoverage = 2.0; 
                    suggestion = Math.ceil((item.demanda * targetCoverage) - item.qtd_disp);
                    if (suggestion < 0) suggestion = 0; 
                }
                
                return {
                    ...item,
                    is_low_stock: needsPurchase,
                    suggestion: suggestion > 0 ? suggestion : null,
                };
            });

            // Agregações (Totais Globais e Revendas)
            const globalTotals = processedData.reduce((acc, item) => {
                METRICS.forEach(m => acc[m.key] = (acc[m.key] || 0) + item[m.key]);
                acc.demanda = (acc.demanda || 0) + item.demanda;
                return acc;
            }, {});

            const revendaMap = processedData.reduce((acc, item) => {
                acc[item.revenda] = acc[item.revenda] || { revenda: item.revenda };
                METRICS.forEach(m => acc[item.revenda][m.key] = (acc[item.revenda][m.key] || 0) + item[m.key]);
                acc[item.revenda].demanda = (acc[item.revenda].demanda || 0) + item.demanda;
                return acc;
            }, {});
            const revendaTotals = Object.values(revendaMap).sort((a, b) => a.revenda - b.revenda);

            // Categorias Únicas
            const categories = [...new Set(data.map(item => item.category))].sort();

            // Sugestões de Compra (Externa)
            const suggestedItems = processedData.filter(item => item.suggestion > 0);

            // Sugestões de Transferência (Interna)
            const transferSuggestions = calculateTransfers(processedData);

            return { processedData, globalTotals, revendaTotals, categories, suggestedItems, transferSuggestions };
        }

        function filterAndSortItems(processedData) {
            let filteredItems = processedData;

            if (selectedCategory !== 'All') {
                filteredItems = filteredItems.filter(item => item.category === selectedCategory);
            }

            if (searchTerm) {
                const lowerCaseSearch = searchTerm.toLowerCase();
                filteredItems = filteredItems.filter(item =>
                    item.sku.toLowerCase().includes(lowerCaseSearch) ||
                    item.desc.toLowerCase().includes(lowerCaseSearch)
                );
            }

            if (activeTab === 'details' && showSuggestionsOnly) {
                filteredItems = filteredItems.filter(item => item.is_low_stock);
            }

            return filteredItems;
        }

        // --- Função Principal de Renderização ---

        function renderApp() {
            const { processedData, globalTotals, revendaTotals, categories, suggestedItems, transferSuggestions } = processData(currentStockData);
            const filteredItems = filterAndSortItems(processedData);

            let appContent = `
                <h1 class="text-3xl sm:text-4xl font-extrabold text-gray-900 mb-6 border-b pb-2">
                    Gestão Centralizada de Estoque
                </h1>
                <p class="text-gray-600 mb-8">
                    Visão diária consolidada das quantidades e sugestões de abastecimento.
                </p>

                <!-- 1. Totais Globais (Consolidado) -->
                <div id="global-totals"></div>

                <!-- 2. Abas de Visualização -->
                <div class="flex space-x-2 border-b border-gray-200 mb-6 overflow-x-auto pb-1">
                    <button id="tab-details" onclick="setActiveTab('details')" 
                        class="px-4 py-2 text-sm font-medium rounded-t-lg transition duration-150 whitespace-nowrap
                        ${activeTab === 'details' ? 'bg-white border-t border-x border-gray-200 text-indigo-700' : 'text-gray-500 hover:bg-gray-100'}">
                        Detalhes do Item e Revendas
                    </button>
                    <button id="tab-suggestions" onclick="setActiveTab('suggestions')" 
                        class="px-4 py-2 text-sm font-medium rounded-t-lg transition duration-150 whitespace-nowrap
                        ${activeTab === 'suggestions' ? 'bg-white border-t border-x border-gray-200 text-red-700' : 'text-gray-500 hover:bg-gray-100'}">
                        Sugestão de Compras (${suggestedItems.length})
                    </button>
                    <button id="tab-transfers" onclick="setActiveTab('transfers')" 
                        class="px-4 py-2 text-sm font-medium rounded-t-lg transition duration-150 whitespace-nowrap
                        ${activeTab === 'transfers' ? 'bg-white border-t border-x border-gray-200 text-green-700' : 'text-gray-500 hover:bg-gray-100'}">
                        Sugestão de Transferências (${transferSuggestions.length})
                    </button>
                    <button id="tab-orders" onclick="setActiveTab('orders')" 
                        class="px-4 py-2 text-sm font-medium rounded-t-lg transition duration-150 whitespace-nowrap
                        ${activeTab === 'orders' ? 'bg-white border-t border-x border-gray-200 text-purple-700' : 'text-gray-500 hover:bg-gray-100'}">
                        Pedidos em Andamento (${currentPendingOrders.length})
                    </button>
                </div>

                <!-- 3. Conteúdo da Aba -->
                <div id="tab-content"></div>

                <!-- 4. Totais por Revenda -->
                <div id="revenda-totals-container" class="mt-12"></div>

                <footer class="mt-12 text-center text-sm text-gray-500">
                    Sistema de Gestão de Estoque - Solução Gratuita (HTML) com persistência local.
                </footer>
            `;

            document.getElementById('app').innerHTML = appContent;

            // Renderiza o conteúdo principal
            renderGlobalTotals(globalTotals);
            renderRevendaTotals(revendaTotals);
            renderTabContent(filteredItems, suggestedItems, transferSuggestions, categories);
            
            // Re-bind listeners para inputs e botões
            document.getElementById('search-input')?.addEventListener('input', handleSearchChange);
            document.getElementById('category-select')?.addEventListener('change', handleCategoryChange);
            document.getElementById('suggestions-toggle')?.addEventListener('change', handleToggleChange);
            document.getElementById('update-stock-button')?.addEventListener('click', handleUpdateStockClick);
            document.getElementById('update-orders-button')?.addEventListener('click', handleUpdateOrdersClick);
        }

        function renderTabContent(filteredItems, suggestedItems, transferSuggestions, categories) {
            const tabContentDiv = document.getElementById('tab-content');
            
            if (activeTab === 'details') {
                tabContentDiv.innerHTML = `
                    <!-- Bloco de Filtros e Busca para Detalhes -->
                    <div class="bg-white p-6 rounded-xl shadow-lg mb-8 border-t-2 border-indigo-300">
                        <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                            <!-- Filtro por Categoria -->
                            <div>
                                <label for="category-select" class="block text-sm font-medium text-gray-700 mb-1">
                                    Filtrar por Categoria
                                </label>
                                <select id="category-select" value="${selectedCategory}" class="w-full p-2.5 border border-gray-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
                                    <option value="All">Todas as Categorias</option>
                                    ${categories.map(c => `<option value="${c}" ${selectedCategory === c ? 'selected' : ''}>${c}</option>`).join('')}
                                </select>
                            </div>

                            <!-- Busca por SKU/Descrição -->
                            <div class="md:col-span-2">
                                <label for="search-input" class="block text-sm font-medium text-gray-700 mb-1">
                                    Buscar por SKU ou Descrição
                                </label>
                                <input type="text" id="search-input" value="${searchTerm}" placeholder="Ex: GS55553R2BRA ou TAPETE"
                                    class="w-full p-2.5 border border-gray-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500"
                                />
                            </div>

                            <!-- Toggle Sugestão -->
                            <div class="flex items-center pt-5">
                                <input type="checkbox" id="suggestions-toggle" ${showSuggestionsOnly ? 'checked' : ''}
                                    class="h-4 w-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500"
                                />
                                <label for="suggestions-toggle" class="ml-2 block text-sm font-medium text-gray-700">
                                    Mostrar APENAS Sugestões de Compra
                                </label>
                            </div>
                        </div>
                    </div>

                    <!-- Componente de Atualização Manual -->
                    <div id="data-updater-stock-container"></div>
                    
                    <!-- Tabela de Itens Detalhada -->
                    <h3 class="text-xl font-bold text-gray-800 mb-3 mt-8">Itens (${filteredItems.length})</h3>
                    <div id="item-table-details"></div>
                `;
                
                renderDataUpdaterStock(currentStockData);
                renderItemTable(filteredItems, 'item-table-details', false);

            } else if (activeTab === 'suggestions') {
                tabContentDiv.innerHTML = `
                    <div class="p-6 rounded-xl shadow-lg mb-8 border-t-2 border-red-500 bg-white">
                        <h3 class="text-xl font-bold text-red-700 mb-3">
                            Itens Prioritários para Compra Externa - Abastecer Agora (${suggestedItems.length})
                        </h3>
                        <p class="text-sm text-gray-600">
                            **Critério:** Estoque Disponível é menor que 1.5 meses da Demanda Média. A sugestão é comprar o suficiente para atingir 2 meses de cobertura.
                        </p>
                    </div>
                    <div id="item-table-suggestions"></div>
                `;
                renderItemTable(suggestedItems, 'item-table-suggestions', true);

            } else if (activeTab === 'transfers') {
                tabContentDiv.innerHTML = `
                    <div id="transfer-table-container"></div>
                `;
                document.getElementById('transfer-table-container').innerHTML = renderTransferSuggestions(transferSuggestions);
            
            } else if (activeTab === 'orders') {
                tabContentDiv.innerHTML = `
                    <div id="pending-orders-table-container"></div>
                    <div id="data-updater-orders-container"></div>
                `;
                document.getElementById('pending-orders-table-container').innerHTML = renderPendingOrders(currentPendingOrders);
                renderDataUpdaterOrders(currentPendingOrders);
            }
        }
        
        // Novo: Updater para Estoque
        function renderDataUpdaterStock(initialData) {
            const container = document.getElementById('data-updater-stock-container');
            const defaultJson = JSON.stringify(initialData, null, 2);
            
            container.innerHTML = `
                <div class="mt-8 p-6 bg-yellow-50 rounded-xl shadow-lg border-t-2 border-yellow-500">
                    <h3 class="text-xl font-bold text-yellow-800 mb-3">
                        Atualização Manual de ESTOQUE (JSON)
                    </h3>
                    <p class="text-sm text-gray-700 mb-4">
                        Cole o array JSON do seu estoque (incluindo as colunas de curva - ex: "curve": "A-1") e clique em Atualizar.
                    </p>
                    <textarea id="json-input-stock" rows="10" class="w-full p-2 border border-yellow-300 rounded-lg focus:ring-yellow-500 focus:border-yellow-500 text-xs font-mono">${defaultJson}</textarea>
                    <p id="json-error-stock" class="text-sm text-red-600 mt-2 font-semibold"></p>
                    <button id="update-stock-button" class="mt-3 w-full px-4 py-2 bg-yellow-600 text-white font-semibold rounded-lg shadow-md hover:bg-yellow-700 transition duration-150">
                        Atualizar ESTOQUE e Salvar no Navegador
                    </button>
                </div>
            `;
            document.getElementById('update-stock-button').addEventListener('click', handleUpdateStockClick);
        }

        // Novo: Updater para Pedidos
        function renderDataUpdaterOrders(initialData) {
            const container = document.getElementById('data-updater-orders-container');
            const defaultJson = JSON.stringify(initialData, null, 2);
            
            container.innerHTML = `
                <div class="mt-8 p-6 bg-yellow-50 rounded-xl shadow-lg border-t-2 border-purple-500">
                    <h3 class="text-xl font-bold text-purple-800 mb-3">
                        Atualização Manual de PEDIDOS EM ANDAMENTO (JSON)
                    </h3>
                    <p class="text-sm text-gray-700 mb-4">
                        Cole o array JSON dos seus pedidos (SKU, Qtd., Fornecedor, Status, Previsão) e clique em Atualizar.
                    </p>
                    <textarea id="json-input-orders" rows="10" class="w-full p-2 border border-yellow-300 rounded-lg focus:ring-purple-500 focus:border-purple-500 text-xs font-mono">${defaultJson}</textarea>
                    <p id="json-error-orders" class="text-sm text-red-600 mt-2 font-semibold"></p>
                    <button id="update-orders-button" class="mt-3 w-full px-4 py-2 bg-purple-600 text-white font-semibold rounded-lg shadow-md hover:bg-purple-700 transition duration-150">
                        Atualizar PEDIDOS e Salvar no Navegador
                    </button>
                </div>
            `;
            document.getElementById('update-orders-button').addEventListener('click', handleUpdateOrdersClick);
        }

        // --- Handlers de Eventos ---

        function handleSearchChange(e) {
            searchTerm = e.target.value;
            renderApp();
        }

        function handleCategoryChange(e) {
            selectedCategory = e.target.value;
            renderApp();
        }
        
        function handleToggleChange(e) {
            showSuggestionsOnly = e.target.checked;
            renderApp();
        }

        function setActiveTab(tab) {
            activeTab = tab;
            renderApp();
        }

        function handleUpdateStockClick() {
            const jsonInput = document.getElementById('json-input-stock').value;
            const errorElement = document.getElementById('json-error-stock');
            errorElement.textContent = '';

            try {
                const newStockData = JSON.parse(jsonInput);
                if (!Array.isArray(newStockData) || newStockData.length === 0 || !newStockData[0].sku || !newStockData[0].curve) {
                    throw new Error("O JSON deve ser um array com as chaves 'sku' e 'curve'.");
                }
                
                currentStockData = newStockData;
                saveStockData(currentStockData, currentPendingOrders); // Salva o estoque e os pedidos
                renderApp();

                errorElement.textContent = "Estoque atualizado e salvo no seu navegador!";
                errorElement.classList.remove('text-red-600');
                errorElement.classList.add('text-green-600');
                setTimeout(() => errorElement.textContent = '', 5000);
                
            } catch (e) {
                errorElement.textContent = `Erro ao processar JSON: ${e.message}. Verifique a sintaxe.`;
                errorElement.classList.remove('text-green-600');
                errorElement.classList.add('text-red-600');
            }
        }
        
        function handleUpdateOrdersClick() {
            const jsonInput = document.getElementById('json-input-orders').value;
            const errorElement = document.getElementById('json-error-orders');
            errorElement.textContent = '';

            try {
                const newOrdersData = JSON.parse(jsonInput);
                if (!Array.isArray(newOrdersData)) {
                    throw new Error("O JSON deve ser um array de objetos de pedidos.");
                }
                
                currentPendingOrders = newOrdersData;
                saveStockData(currentStockData, currentPendingOrders); // Salva os pedidos e o estoque
                renderApp();

                errorElement.textContent = "Pedidos atualizados e salvos no seu navegador!";
                errorElement.classList.remove('text-red-600');
                errorElement.classList.add('text-green-600');
                setTimeout(() => errorElement.textContent = '', 5000);
                
            } catch (e) {
                errorElement.textContent = `Erro ao processar JSON: ${e.message}. Verifique a sintaxe.`;
                errorElement.classList.remove('text-green-600');
                errorElement.classList.add('text-red-600');
            }
        }

        // --- Lógica de Processamento ---

        function calculateTransfers(processedData) {
            const transferSuggestions = [];
            const itemsBySku = processedData.reduce((acc, item) => {
                acc[item.sku] = acc[item.sku] || [];
                // Adiciona a cobertura formatada para facilitar a ordenação e a exibição
                acc[item.sku].push({ 
                    ...item, 
                    coverageValue: calculateCoverage(item.qtd_disp, item.demanda) 
                });
                return acc;
            }, {});

            for (const sku in itemsBySku) {
                const locations = itemsBySku[sku];
                if (locations.length < 2) continue; // Precisa de pelo menos duas revendas para transferência

                // Ordenar por Cobertura: Menor cobertura = Risco (Deficit), Maior cobertura = Excesso (Surplus)
                locations.sort((a, b) => a.coverageValue - b.coverageValue);

                const deficitItem = locations[0];
                const surplusItem = locations[locations.length - 1];

                // Regras de Transferência:
                // 1. Deficit: Cobertura de risco (abaixo de 1.0 mês) E demanda > 0
                // 2. Surplus: Cobertura de excesso (acima de 3.0 meses) E tem estoque disponível
                
                const isDeficit = deficitItem.coverageValue < 1.0 && deficitItem.demanda > 0;
                const isSurplus = surplusItem.coverageValue > 3.0 && surplusItem.qtd_disp > 0;

                if (isDeficit && isSurplus) {
                    // Cálculo da Quantidade: Transferir o necessário para o deficit atingir 2 meses
                    const targetCoverage = 2.0; 
                    const neededQty = Math.ceil((deficitItem.demanda * targetCoverage) - deficitItem.qtd_disp);
                    
                    if (neededQty > 0) {
                        const transferQty = Math.min(neededQty, surplusItem.qtd_disp);
                        
                        // Não sugerir se a transferência não for significativa (ex: < 5 unidades)
                        if (transferQty >= 5) { 
                             transferSuggestions.push({
                                sku: sku,
                                desc: deficitItem.desc,
                                category: deficitItem.category,
                                curve: deficitItem.curve,
                                fromRevenda: surplusItem.revenda,
                                toRevenda: deficitItem.revenda,
                                transferQty: transferQty,
                                deficitCoverage: formatCoverage(deficitItem.coverageValue),
                                surplusCoverage: formatCoverage(surplusItem.coverageValue),
                            });
                        }
                    }
                }
            }

            // Priorizar transferências por Curva (A > B > C)
            transferSuggestions.sort((a, b) => {
                const curveOrder = { 'A-1': 1, 'A-2': 2, 'A-3': 3, 'B-1': 4, 'B-2': 5, 'B-3': 6, 'C-1': 7, 'C-2': 8, 'C-3': 9 };
                return curveOrder[a.curve] - curveOrder[b.curve];
            });

            return transferSuggestions;
        }

        function processData(data) {
            const processedData = data.map(item => {
                // Lógica de Sugestão de Compra (Externa)
                const safetyStockThreshold = item.demanda * 1.5; 
                const needsPurchase = item.demanda > 0 && item.qtd_disp < safetyStockThreshold;
                
                let suggestion = 0;
                if (needsPurchase) {
                    const targetCoverage = 2.0; 
                    suggestion = Math.ceil((item.demanda * targetCoverage) - item.qtd_disp);
                    if (suggestion < 0) suggestion = 0; 
                }
                
                return {
                    ...item,
                    is_low_stock: needsPurchase,
                    suggestion: suggestion > 0 ? suggestion : null,
                };
            });

            // Agregações (Totais Globais e Revendas)
            const globalTotals = processedData.reduce((acc, item) => {
                METRICS.forEach(m => acc[m.key] = (acc[m.key] || 0) + item[m.key]);
                acc.demanda = (acc.demanda || 0) + item.demanda;
                return acc;
            }, {});

            const revendaMap = processedData.reduce((acc, item) => {
                acc[item.revenda] = acc[item.revenda] || { revenda: item.revenda };
                METRICS.forEach(m => acc[item.revenda][m.key] = (acc[item.revenda][m.key] || 0) + item[m.key]);
                acc[item.revenda].demanda = (acc[item.revenda].demanda || 0) + item.demanda;
                return acc;
            }, {});
            const revendaTotals = Object.values(revendaMap).sort((a, b) => a.revenda - b.revenda);

            // Categorias Únicas
            const categories = [...new Set(data.map(item => item.category))].sort();

            // Sugestões de Compra (Externa)
            const suggestedItems = processedData.filter(item => item.suggestion > 0);

            // Sugestões de Transferência (Interna)
            const transferSuggestions = calculateTransfers(processedData);

            return { processedData, globalTotals, revendaTotals, categories, suggestedItems, transferSuggestions };
        }

        function filterAndSortItems(processedData) {
            let filteredItems = processedData;

            if (selectedCategory !== 'All') {
                filteredItems = filteredItems.filter(item => item.category === selectedCategory);
            }

            if (searchTerm) {
                const lowerCaseSearch = searchTerm.toLowerCase();
                filteredItems = filteredItems.filter(item =>
                    item.sku.toLowerCase().includes(lowerCaseSearch) ||
                    item.desc.toLowerCase().includes(lowerCaseSearch)
                );
            }

            if (activeTab === 'details' && showSuggestionsOnly) {
                filteredItems = filteredItems.filter(item => item.is_low_stock);
            }

            return filteredItems;
        }


        // --- Inicialização ---
        window.onload = function() {
            loadStockData(); // Carrega estoque e pedidos
            renderApp();
        };
    </script>
</body>
</html>
